#!/usr/bin/env node
import { Command } from "commander";
import chalk from "chalk";
import { enqueueJob, listJobs, showStatus } from "../lib/queue.js";
import { startWorkers, stopWorkers } from "../lib/worker.js";
import { listDLQ, retryDLQJob } from "../lib/db.js";
import { setConfig, getConfig } from "../lib/config.js";

const program = new Command();
program
  .name("queuectl")
  .description("CLI-based background job queue system")
  .version("1.0.0");

program
  .command("enqueue <jobJson>")
  .description("Add a new job to the queue")
  .action(async (jobJson) => {
    try {
      const job = JSON.parse(jobJson);
      await enqueueJob(job);
      console.log(chalk.green("✅ Job enqueued successfully"));
    } catch (err) {
      console.error(chalk.red("❌ Failed to enqueue job:"), err.message);
    }
  });

program
  .command("worker")
  .description("Manage worker processes")
  .option("start", "Start workers")
  .option("--count <n>", "Number of workers", "1")
  .option("stop", "Stop workers")
  .action(async (options) => {
    if (options.start) await startWorkers(parseInt(options.count));
    else if (options.stop) await stopWorkers();
    else console.log("Use --start or --stop");
  });

program
  .command("status")
  .description("Show job and worker status")
  .action(showStatus);

program
  .command("list")
  .option("--state <state>", "Filter by job state")
  .description("List jobs by state")
  .action(listJobs);

program
  .command("dlq")
  .description("Dead Letter Queue operations")
  .option("list", "List DLQ jobs")
  .option("retry <id>", "Retry a DLQ job")
  .action(async (options) => {
    if (options.list) await listDLQ();
    else if (options.retry) await retryDLQJob(options.retry);
    else console.log("Use 'dlq list' or 'dlq retry <id>'");
  });

program
  .command("config")
  .description("Configuration management")
  .option("set <key> <value>", "Set config value")
  .option("get <key>", "Get config value")
  .action(async (options) => {
    if (options.set) await setConfig(options.set[0], options.set[1]);
    else if (options.get) await getConfig(options.get);
  });

program.parse(process.argv);
